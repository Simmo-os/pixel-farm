name: ğŸ› ï¸ Setup (Final Fix with Escape)

on: workflow_dispatch

permissions:
  contents: write

jobs:
  configure-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Auto-Modify Files & Generate Config
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const repoName = context.repo.repo;
            console.log(`ğŸ”§ Configuring for repository: ${repoName}`);

            // 1. ä¿®æ­£ index.html
            if (fs.existsSync('index.html')) {
              let html = fs.readFileSync('index.html', 'utf8');
              html = html.replace(/<script type="importmap">[\s\S]*?<\/script>/, '');
              if (!html.includes('src="/index.tsx"')) {
                html = html.replace('</body>', '    <script type="module" src="/index.tsx"></script>\n  </body>');
              }
              fs.writeFileSync('index.html', html);
              console.log('âœ… index.html updated.');
            }

            // 2. é‡å†™ vite.config.ts (ESM å…¼å®¹ç‰ˆ)
            const viteConfigLines = [
              "import { defineConfig } from 'vite';",
              "import react from '@vitejs/plugin-react';",
              "import path from 'path';",
              "import { fileURLToPath } from 'url';",
              "",
              "const __filename = fileURLToPath(import.meta.url);",
              "const __dirname = path.dirname(__filename);",
              "",
              "export default defineConfig({",
              `  base: '/${repoName}/',`,
              "  plugins: [react()],",
              "  resolve: {",
              "    alias: {",
              "      '@': path.resolve(__dirname, '.'),",
              "    }",
              "  },",
              "  server: {",
              "    host: '0.0.0.0',",
              "  }",
              "});"
            ];
            fs.writeFileSync('vite.config.ts', viteConfigLines.join('\n'));
            console.log('âœ… vite.config.ts updated.');

            // 3. ç”Ÿæˆ Deploy.yml (å…³é”®ä¿®æ­£ï¼šé˜²æ­¢å˜é‡è¢«æå‰è§£æ)
            // æˆ‘ä»¬æŠŠ '$' å’Œ '{{' åˆ†å¼€ï¼Œè¿™æ · Setup æµç¨‹å°±ä¸ä¼šæŠŠå®ƒå½“æˆå˜é‡åƒæ‰äº†
            const pageUrlExpression = '$' + '{{ steps.deployment.outputs.page_url }}';

            const deployLines = [
              "name: Deploy to GitHub Pages",
              "",
              "on:",
              "  push:",
              "    branches: [ main, master ]",
              "  workflow_dispatch:",
              "",
              "permissions:",
              "  contents: read",
              "  pages: write",
              "  id-token: write",
              "",
              "jobs:",
              "  build:",
              "    runs-on: ubuntu-latest",
              "    steps:",
              "      - uses: actions/checkout@v4",
              "      - uses: actions/setup-node@v4",
              "        with:",
              "          node-version: 20",
              "      - run: npm install",
              "      - run: npm run build",
              "      - uses: actions/upload-pages-artifact@v3",
              "        with:",
              "          path: ./dist",
              "",
              "  deploy:",
              "    needs: build",
              "    runs-on: ubuntu-latest",
              "    environment:",
              "      name: github-pages",
              `      url: ${pageUrlExpression}`,  // è¿™é‡Œä½¿ç”¨äº†æ‹¼æ¥åçš„å˜é‡
              "    steps:",
              "      - id: deployment",
              "        uses: actions/deploy-pages@v4"
            ];
            
            const deployYamlContent = deployLines.join('\n');

            // æ‰“å°æ—¥å¿—
            console.log("\\n\\n" + "=".repeat(60));
            console.log("ğŸ“‹ ã€è¯·å®Œæ•´å¤åˆ¶ä¸‹æ–¹å†…å®¹ (Copy Below)ã€‘ ğŸ“‹");
            console.log("ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡");
            console.log(deployYamlContent);
            console.log("ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†");
            console.log("=".repeat(60) + "\\n\\n");

      - name: Commit Modified Files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html vite.config.ts
          git commit -m "Auto-configure project files" || echo "No changes to commit"
          git push
