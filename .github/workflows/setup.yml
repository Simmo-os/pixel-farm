name: ğŸš€ One-Click Setup (Run Once)

# å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘
on: workflow_dispatch

# èµ‹äºˆè„šæœ¬ä¿®æ”¹ä»“åº“ä»£ç çš„æƒé™
permissions:
  contents: write

jobs:
  configure-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Auto-Configuration Script
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // 1. è·å–å½“å‰ä»“åº“åç§° (ç”¨äºè®¾ç½® base path)
            const repoName = context.repo.repo;
            console.log(`ğŸ”§ Configuring for repository: ${repoName}`);

            // 2. ä¿®æ­£ index.html
            // å»æ‰ importmap å¹¶æ³¨å…¥ react å…¥å£
            if (fs.existsSync('index.html')) {
              let html = fs.readFileSync('index.html', 'utf8');
              const originalLength = html.length;
              
              // ç§»é™¤ importmap
              html = html.replace(/<script type="importmap">[\s\S]*?<\/script>/, '');
              
              // æ³¨å…¥å…¥å£è„šæœ¬
              if (!html.includes('src="/index.tsx"')) {
                html = html.replace('</body>', '    <script type="module" src="/index.tsx"></script>\n  </body>');
              }
              
              fs.writeFileSync('index.html', html);
              console.log('âœ… index.html updated');
            } else {
              console.log('âš ï¸ index.html not found, skipping');
            }

            // 3. é‡å†™ vite.config.ts
            // æ³¨å…¥æ­£ç¡®çš„ base è·¯å¾„å’Œé…ç½®
            const newViteConfig = `
            import { defineConfig } from 'vite';
            import react from '@vitejs/plugin-react';
            import path from 'path';

            export default defineConfig({
              base: '/${repoName}/',
              plugins: [react()],
              resolve: {
                alias: {
                  '@': path.resolve(__dirname, '.'),
                }
              },
              server: {
                host: '0.0.0.0',
              }
            });
            `;
            fs.writeFileSync('vite.config.ts', newViteConfig.trim());
            console.log('âœ… vite.config.ts configured');

            // 4. åˆ›å»ºè‡ªåŠ¨éƒ¨ç½²æµç¨‹æ–‡ä»¶ (deploy.yml)
            const deployWorkflow = `name: Deploy to GitHub Pages

            on:
              push:
                branches: [ main, master ]
              workflow_dispatch:

            permissions:
              contents: read
              pages: write
              id-token: write

            jobs:
              build:
                runs-on: ubuntu-latest
                steps:
                  - uses: actions/checkout@v4
                  - uses: actions/setup-node@v4
                    with:
                      node-version: 20
                  - run: npm install
                  - run: npm run build
                  - uses: actions/upload-pages-artifact@v3
                    with:
                      path: ./dist
              deploy:
                environment:
                  name: github-pages
                  url: \${{ steps.deployment.outputs.page_url }}
                needs: build
                runs-on: ubuntu-latest
                steps:
                  - id: deployment
                    uses: actions/deploy-pages@v4
            `;
            
            const workflowDir = '.github/workflows';
            if (!fs.existsSync(workflowDir)) fs.mkdirSync(workflowDir, { recursive: true });
            fs.writeFileSync(path.join(workflowDir, 'deploy.yml'), deployWorkflow);
            console.log('âœ… deploy.yml created');

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html vite.config.ts .github/workflows/deploy.yml
          git commit -m "Auto-configure project for GitHub Pages" || echo "No changes to commit"
          git push
